#include "loading_screen.h"

constexpr uint8_t k_logo[] = {
    0xE0, 0xE0, 0xE0, 0xFE, 0xFE, 0xFE, 0xE0, 0xE0, 0xE0, 0x00, 0x00, 0x00,
    0x00, 0xE0, 0xEE, 0xEE, 0xEE, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xE0, 0xE0,
    0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xC0, 0x80, 0x00, 0x00, 0x00,
    0xE0, 0xE0, 0xE0, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xE0, 0xE0, 0x00, 0x00,
    0x00, 0xFF, 0x05, 0xFF, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0xFF, 0x04,
    0xFC, 0x00, 0x00, 0x00, 0xFF, 0x05, 0xFF, 0x05, 0x05, 0x05, 0x05, 0x05,
    0x05, 0xFF, 0x04, 0xFC, 0x00, 0x00, 0x00, 0x7C, 0x44, 0xFF, 0x45, 0x45,
    0x45, 0x45, 0x45, 0x45, 0xDF, 0x14, 0x1C, 0x00, 0x00, 0x00, 0x3F, 0x7F,
    0x7F, 0x70, 0x70, 0x70, 0x70, 0x00, 0x00, 0x00, 0x70, 0x7F, 0x7F, 0x7F,
    0x70, 0x00, 0x00, 0x00, 0x7F, 0x7F, 0x7F, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x7F, 0x7F, 0x7F, 0x00, 0x00, 0x00, 0x1F, 0x3F, 0x7F, 0x70, 0x70,
    0x70, 0x70, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x7F, 0x45, 0x7F, 0x05,
    0x05, 0x05, 0x05, 0x05, 0x05, 0x07, 0x01, 0x01, 0x00, 0x00, 0x00, 0x7F,
    0x45, 0x7F, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x07, 0x01, 0x01, 0x00,
    0x00, 0x00, 0x1C, 0x14, 0x7D, 0x51, 0x51, 0x51, 0x51, 0x51, 0x51, 0x7F,
    0x11, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x06, 0x06, 0x06, 0x06, 0x06, 0x07, 0x07, 0x03, 0x01,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
constexpr uint8_t k_logo_width = 91;
constexpr uint8_t k_logo_height = 19;

LoadingScreen::LoadingScreen(uint16_t width, uint16_t height)
    : Screen(width, height), m_progress(0) {}

uint8_t* LoadingScreen::build() {
    clear();
    // Logo
    draw((m_width - k_logo_width) / 2, (m_height - k_logo_height) / 2, k_logo,
         k_logo_width, k_logo_height);
    // if PDO count is not set show the progress bar, otherwise show the number
    // of PDO profiles
    if (m_pdo_profile_count.has_value()) {
        std::string profiles_found_text =
            std::to_string(m_pdo_profile_count.value()) + " PDOs found";
        printString(m_width / 2, 48, profiles_found_text,
                    {.align = TextAlign::center});
    } else {
        std::string loading_text(m_progress, '.');
        printString(m_width / 2, 50, loading_text,
                    {.align = TextAlign::center, .size = FontSize::big});
        printString(m_width / 2, 48, "Loading PDOs",
                    {.align = TextAlign::center});
    }

    return m_frame_buffer;
}

LoadingScreen& LoadingScreen::updateProgress() {
    m_progress = ++m_progress % 4;
    return *this;
}

LoadingScreen& LoadingScreen::setPdoProfileCount(uint8_t count) {
    m_pdo_profile_count = count;
    return *this;
}